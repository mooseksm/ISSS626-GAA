---
title: "Take-home Exercise 1B"
author: "Kock Si Min"
date: September 2, 2024
date-modified: "last-modified"
toc: true
execute:
  eval: true
  echo: true
  freeze: true
  warning: false
  message: false
---

# Take-Home Exercise 1: Geospatial Analytics for Public Good (Part 1B)

#### Loading the necessary R packages and data created in [Part 1A](https://isss626-ksm.netlify.app/take-home_ex/take-home_ex01/take-home_ex01a)

```{r}
#| echo: false
# increased timeout to mitigate error issues during rendering
options(timeout = 5000)
# setting the seed for any simulation steps carried out in the exercise
set.seed(1234)
```

```{r}
#| code-fold: true
pacman::p_load(sf,spatstat,sparr,raster,maptools,tmap,tidyverse,spNetwork,DT,forcats,ggthemes,plotly,RColorBrewer)
```

```{r}
#| code-fold: true
# loading datasets for analysis
#refer to Part 1A for earlier steps on data wrangling
roadacc <- read_rds("data/rds/roadacc.rds")
roadsbkk <- read_rds("data/rds/roadsbkk.rds")
provincedata32647 <- read_rds("data/rds/provincedata32647.rds")
roadacc_month_bkk <- read_rds("data/rds/roadacc_month_bkk.rds")
roadacc_month_sp <- read_rds("data/rds/roadacc_month_sp.rds")
roadacc_month_n <- read_rds("data/rds/roadacc_month_n.rds")
roadacc_month_pt <- read_rds("data/rds/roadacc_month_pt.rds")
roadacc_month_np <- read_rds("data/rds/roadacc_month_np.rds")
roadacc_month_ss <- read_rds("data/rds/roadacc_month_ss.rds")
```

## 7. Spatial Point Pattern Analysis (SPPA)

We will conduct a Spatial Point Pattern Analysis (SPPA) to evaluate the distribution of road accidents within the Bangkok Metropolitan Region (BMR).

The specific questions we would like to answer are as follows:

-   are the road accidents in BMR randomly distributed throughout the region?

-   if no, then where are the locations with higher concentration of road accidents?

Specifically, we will be carrying out the following SPPA methods:

-   First-order SPPA

-   Spatial analysis of road traffic accidents using Network SPPA methods.

-   Spatio-temporal analysis of road accidents using Temporal Network SPPA methods.

### 7.1 Data Wrangling for SPPA

### 7.1.1 Converting data to ppp format for Spatial Point Pattern Analysis

Before we carry out spatial point pattern analysis, we need to convert the data from sf format to ppp format:

```{r}
roadacc_ppp <- as.ppp(roadacc)
roadacc_ppp
```

The code chunk below plots *roadacc_ppp* for visualisation:

```{r}
plot(roadacc_ppp)
```

We take a quick look at the summary statistics of the *roadacc_ppp* object using the code chunk below:

```{r}
summary(roadacc_ppp)
```

### 7.1.2 Checking for duplicate points

In SPPA, a significant issue is the presence of duplicates as the statistical methodology used for spatial point patterns processes is based largely on the assumption that process are simple i.e. that the points cannot be coincident. We check for duplication in a *ppp* object via the code chunk below:

```{r}
any(duplicated(roadacc_ppp))
```

The data does not have any duplicated points.

### 7.1.3 Creating an *owin* object

When analysing spatial point patterns, it is a good practice to confine the analysis within a geographical area like Singapore boundary. In **spatstat**, an object called *owin* is specially designed to represent this polygonal region. The code chunk below is used to covert *provincedata32647* SpatialPolygon object into owin object of **spatstat**:

```{r}
provinceowin <- as.owin(provincedata32647)
```

The ouput object can be displayed by using *plot()* function

```{r}
plot(provinceowin)
```

```{r}
summary(provinceowin)
```

### 7.1.4 Combining point events object and owin object

We extract road accident events that are located within the BMR by using the code chunk below:

```{r}
roadacc_owin_ppp = roadacc_ppp[provinceowin]
```

```{r}
plot(roadacc_owin_ppp)
```

```{r}
summary(roadacc_owin_ppp)
```

### 7.2 First-order SPPA

The first-order SPPA will study how the intensity of road accidents vary across the BMR i.e. identify whether road accidents are more concentrated in areas due to underlying properties of the spatial environment.

For first-order SPPA, we will:

-   derive the **kernel density estimation (KDE)** layer for visualising and exploring the intensity of point processes,

-   perform **Confirmatory SPPA** using **Nearest Neighbour** statistics to determine if the road accidents are randomly distributed or influenced by underlying properties of the spatial environment.

### 7.2.1 Kernel Density Estimation (KDE)

We will proceed to compute the KDE of road accidents in the BMR. However, before we do so, we convert the unit of measurement to kilometer as the default unit of measurement of EPSG: 32647 is in metres, which would make the values hard to comprehend:

```{r}
roadacc_owin_ppp.km <- rescale.ppp(roadacc_owin_ppp,1000,"km")
```

### 7.2.1.1 Computing KDE using automatic bandwidth selection

We will derive KDE using *bw.diggle()* of spatstat as it is an automatic bandwidth selection method and does not require a fixed bandwidth to be defined.

```{r}
kde_roadacc_bw <- density(roadacc_owin_ppp.km,
                          sigma = bw.diggle,
                          edge = TRUE,
                          kernel = "gaussian")
```

```{r}
plot(kde_roadacc_bw)
```

We can retrieve the bandwidth used to compute the KDE layer with the code chunk below:

```{r}
bw <- bw.diggle(roadacc_owin_ppp)
bw
```

### 7.2.1.2 Converting KDE output into grid object

We convert the KDE output for mapping purposes:

```{r}
gridded_kde_roadacc_bw <- as.SpatialGridDataFrame.im(kde_roadacc_bw)
spplot(gridded_kde_roadacc_bw)
```

### 7.2.1.3 Converting gridded output into raster

Next, we will convert the gridded KDE object into a RasterLayer object using *raster()* of **raster package**:

```{r}
kde_roadacc_bw_raster <- raster(kde_roadacc_bw)
```

We view the properties of *kde_roadacc_bw_raster* RasterLayer:

```{r}
kde_roadacc_bw_raster
```

Note that the CRS property is NA.

### 7.2.1.4 Assigning projection system

We hence assign CRS information to the *kde_roadacc_bw_raster* RasterLayer:

```{r}
projection(kde_roadacc_bw_raster) <- CRS("+init=EPSG:32647")

kde_roadacc_bw_raster
```

The CRS property is now completed.

### 7.2.1.5 Visualising the output in tmap

We will display the raster in cartographic quality map using **tmap package**:

```{r}
tmap_mode('plot')
tm_shape(kde_roadacc_bw_raster)+   
  tm_raster("layer",palette = "viridis")+   
  tm_layout(legend.outside = TRUE,             
            legend.outside.position = "right",             
            legend.position = c("right","bottom"),             
            main.title = "Distribution of road accidents (bw.diggle)", 
            main.title.size = 0.8,             
            frame = FALSE)
```

From the plot above, we note that road accidents occur more intensely along the road lines in Bangkok and Samut Prakan. To better understand how the intensity of road accidents occur across the BMR, we will extract the six provinces as different study areas for analysis and comparison in the next section.

### 7.2.2 Comparing Spatial Point Patterns using KDE

### 7.2.2.1 Extracting study areas

The code chunk will be used to extract the different provinces as different study areas:

```{r}
#| eval: false
bkk <- provincedata32647 %>%
  filter(ADM1_EN == "Bangkok")
np <- provincedata32647 %>% 
  filter(ADM1_EN == "Nakhon Pathom") 
n <- provincedata32647 %>%   
  filter(ADM1_EN == "Nonthaburi") 
pt <- provincedata32647 %>%   
  filter(ADM1_EN == "Pathum Thani") 
sp <- provincedata32647 %>%   
  filter(ADM1_EN == "Samut Prakan") 
ss <- provincedata32647 %>%   
  filter(ADM1_EN == "Samut Sakhon")
```

### 7.2.2.2 Creating owin object for each study area

```{r}
#| eval: false
bkk_owin = as.owin(bkk)
np_owin = as.owin(np) 
n_owin = as.owin(n) 
pt_owin = as.owin(pt) 
sp_owin = as.owin(sp) 
ss_owin = as.owin(ss)
```

### 7.2.2.3 Combining road accident points and study area

By using the code chunk below, we are able to extract road accidents that is within the specific province to carry out our analysis later on.

```{r}
#| eval: false
roadacc_bkk_ppp = roadacc_ppp[bkk_owin]
roadacc_np_ppp = roadacc_ppp[np_owin]
roadacc_n_ppp = roadacc_ppp[n_owin]
roadacc_pt_ppp = roadacc_ppp[pt_owin]
roadacc_sp_ppp = roadacc_ppp[sp_owin]
roadacc_ss_ppp = roadacc_ppp[ss_owin]
```

Next, *rescale.ppp()* function is used to transform the unit of measurement from metres to kilometres as EPSG: 32647 is in metres which would produce density values that are too small to comprehend.

```{r}
#| eval: false
roadacc_bkk_ppp.km = rescale.ppp(roadacc_bkk_ppp,1000,"km")
roadacc_np_ppp.km = rescale.ppp(roadacc_np_ppp,1000,"km")
roadacc_n_ppp.km = rescale.ppp(roadacc_n_ppp,1000,"km")
roadacc_pt_ppp.km = rescale.ppp(roadacc_pt_ppp,1000,"km")
roadacc_sp_ppp.km = rescale.ppp(roadacc_sp_ppp,1000,"km")
roadacc_ss_ppp.km = rescale.ppp(roadacc_ss_ppp,1000,"km")
```

We save and load these files to minimise re-running the codes above:

```{r}
#| eval: false
#| code-fold: true
write_rds(roadacc_bkk_ppp.km,"data/rds/roadacc_bkk_ppp.km.rds")
write_rds(roadacc_np_ppp.km,"data/rds/roadacc_np_ppp.km.rds")
write_rds(roadacc_n_ppp.km,"data/rds/roadacc_n_ppp.km.rds")
write_rds(roadacc_pt_ppp.km,"data/rds/roadacc_pt_ppp.km.rds")
write_rds(roadacc_sp_ppp.km,"data/rds/roadacc_sp_ppp.km.rds")
write_rds(roadacc_ss_ppp.km,"data/rds/roadacc_ss_ppp.km.rds")
```

```{r}
roadacc_bkk_ppp.km <- read_rds("data/rds/roadacc_bkk_ppp.km.rds")
roadacc_np_ppp.km <- read_rds("data/rds/roadacc_np_ppp.km.rds")
roadacc_n_ppp.km <- read_rds("data/rds/roadacc_n_ppp.km.rds")
roadacc_pt_ppp.km <- read_rds("data/rds/roadacc_pt_ppp.km.rds")
roadacc_sp_ppp.km <- read_rds("data/rds/roadacc_sp_ppp.km.rds")
roadacc_ss_ppp.km <- read_rds("data/rds/roadacc_ss_ppp.km.rds")
```

We then plot the 6 provinces and the locations of the road accidents:

```{r}
par(mfrow=c(2,3))
plot(roadacc_bkk_ppp.km,main="Bangkok")
plot(roadacc_np_ppp.km,main="Nakhon Pathom")
plot(roadacc_n_ppp.km,main="Nonthaburi") 
plot(roadacc_pt_ppp.km,main="Pathum Thani")
plot(roadacc_sp_ppp.km,main="Samut Prakan")
plot(roadacc_ss_ppp.km,main="Samut Sakhon")
```

### 7.2.2.4 Computing KDE for each study area

We will also derive KDE using *bw.diggle()* of spatstat for all six provinces:

```{r}
#| eval: false
kde_bkk_bw <- density(roadacc_bkk_ppp.km,
                      sigma = bw.diggle,
                      edge = TRUE,
                      kernel = "gaussian")
kde_np_bw <- density(roadacc_np_ppp.km,
                     sigma = bw.diggle,
                     edge = TRUE,
                     kernel = "gaussian")
kde_n_bw <- density(roadacc_n_ppp.km,
                    sigma = bw.diggle,
                    edge = TRUE,
                    kernel = "gaussian")
kde_pt_bw <- density(roadacc_pt_ppp.km,
                     sigma = bw.diggle,
                     edge = TRUE,
                     kernel = "gaussian")
kde_sp_bw <- density(roadacc_sp_ppp.km,
                     sigma = bw.diggle,
                     edge = TRUE,
                     kernel = "gaussian")
kde_ss_bw <- density(roadacc_ss_ppp.km,
                     sigma = bw.diggle,
                     edge = TRUE,
                     kernel = "gaussian")
```

We also save and load these as new rds files to minimise re-running the code above:

```{r}
#| eval: false
#| code-fold: true
write_rds(kde_bkk_bw,"data/rds/kde_bkk_bw.rds")
write_rds(kde_np_bw,"data/rds/kde_np_bw.rds")
write_rds(kde_n_bw,"data/rds/kde_n_bw.rds")
write_rds(kde_pt_bw,"data/rds/kde_pt_bw.rds")
write_rds(kde_sp_bw,"data/rds/kde_sp_bw.rds")
write_rds(kde_ss_bw,"data/rds/kde_ss_bw.rds")
```

```{r}
kde_bkk_bw <- read_rds("data/rds/kde_bkk_bw.rds")
kde_np_bw <- read_rds("data/rds/kde_np_bw.rds")
kde_n_bw <- read_rds("data/rds/kde_n_bw.rds")
kde_pt_bw <- read_rds("data/rds/kde_pt_bw.rds")
kde_sp_bw <- read_rds("data/rds/kde_sp_bw.rds")
kde_ss_bw <- read_rds("data/rds/kde_ss_bw.rds")
```

Next, we will convert the KDE object into a RasterLayer object using *raster()* of **raster package** and assign the CRS of EPSG 32647:

::: panel-tabset
## Bangkok

```{r}
kde_bkk_bw_raster <- raster(kde_bkk_bw)
projection(kde_bkk_bw_raster) <- CRS("+init=EPSG:32647")  
kde_bkk_bw_raster
```

## Nakhon Pathom

```{r}
kde_np_bw_raster <- raster(kde_np_bw)
projection(kde_np_bw_raster) <- CRS("+init=EPSG:32647")  
kde_np_bw_raster
```

## Nonthaburi

```{r}
kde_n_bw_raster <- raster(kde_n_bw)
projection(kde_n_bw_raster) <- CRS("+init=EPSG:32647")  
kde_n_bw_raster
```

## Pathum Thani

```{r}
kde_pt_bw_raster <- raster(kde_pt_bw)
projection(kde_pt_bw_raster) <- CRS("+init=EPSG:32647")  
kde_pt_bw_raster
```

## Samut Prakan

```{r}
kde_sp_bw_raster <- raster(kde_sp_bw)
projection(kde_sp_bw_raster) <- CRS("+init=EPSG:32647")  
kde_sp_bw_raster
```

## Samut Sakhon

```{r}
kde_ss_bw_raster <- raster(kde_ss_bw)
projection(kde_ss_bw_raster) <- CRS("+init=EPSG:32647")
kde_ss_bw_raster
```
:::

### 7.2.2.5 Visualising the output in tmap

We will display the raster in cartographic quality map using **tmap package**:

::: panel-tabset
## Bangkok

```{r}
tm_shape(kde_bkk_bw_raster)+
  tm_raster("layer",palette = "viridis")+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            legend.position = c("right","bottom"),
            main.title = "Distribution of road accidents in Bangkok",
            main.title.size = 0.8,
            frame = FALSE)
```

## Nakhon Pathom

```{r}
tm_shape(kde_np_bw_raster)+
  tm_raster("layer",palette = "viridis")+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            legend.position = c("right","bottom"),
            main.title = "Distribution of road accidents in Nakhon Pathom",
            main.title.size = 0.8,
            frame = FALSE)
```

## Nonthaburi

```{r}
tm_shape(kde_n_bw_raster)+
  tm_raster("layer",palette = "viridis")+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            legend.position = c("right","bottom"),
            main.title = "Distribution of road accidents in Nonthaburi",
            main.title.size = 0.8,
            frame = FALSE)
```

## Pathum Thani

```{r}
tm_shape(kde_pt_bw_raster)+
  tm_raster("layer",palette = "viridis")+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            legend.position = c("right","bottom"),
            main.title = "Distribution of road accidents in Pathum Thani",
            main.title.size = 0.8,
            frame = FALSE)
```

## Samut Prakan

```{r}
tm_shape(kde_sp_bw_raster)+
  tm_raster("layer",palette = "viridis")+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            legend.position = c("right","bottom"),
            main.title = "Distribution of road accidents in Samut Prakan",
            main.title.size = 0.8,
            frame = FALSE)
```

## Samut Sakhon

```{r}
tm_shape(kde_ss_bw_raster)+
  tm_raster("layer",palette = "viridis")+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            legend.position = c("right","bottom"),
            main.title = "Distribution of road accidents in Samut Sakhon",
            main.title.size = 0.8,
            frame = FALSE)
```
:::

From the plots above, we note the maximum KDE for each province (in descending order) and details for each province as follows:

-   [Samut Prakan]{.underline} - up to 600 to 800. Most of the road accidents optically seem to occur at 3 segments.

-   [Bangkok]{.underline} - up to 500 to 600. Most of the road accidents optically seem to occur at major road lines.

-   [Samut Sakhon]{.underline}: Max density up to 300 to 350. Most of the road accidents seem to occur along the same major road.

-   [Pathum Thani]{.underline} - up to 200 to 250. Most of the road accidents seem to occur along the same major road.

-   [Nonthaburi]{.underline} - up to 150 to 200. Most of the road accidents optically seem to be scattered.

-   [Nakhon Pathom]{.underline} - up to 50 to 60. Most of the road accidents optically seem to be scattered.

Further comments are as follows:

-   Notably, while Bangkok is a known tourist destination/major urban hub, it ranks second to Samut Prakan in terms of road accident density.
-   Road accidents seem more scattered in Nonthaburi and Nakhon Pathom which suggest that there could be more complex road systems in these areas where accidents could occur at various points.

## 8. Nearest Neighbour Analysis

After running KDE which shows the density of road accidents over the BMR, we will perform the Clark-Evans test of aggregation to statistically validate the degree of spatial clustering or dispersion of the road accident points by comparing the observed mean nearest neighbor distance with the expected average distance between neighbours in a hypothetical random distribution.

The test hypotheses are:

H0: The distribution of road accidents is randomly distributed.

H1: The distribution of road accidents is not randomly distributed.

The 95% confidence interval will be used.

### 8.1 Testing spatial point patterns using Clark and Evans Test

### 8.1.1 Nearest Neighbour Analysis for overall data

```{r}
clarkevans.test(roadacc_owin_ppp.km,
                correction = "none",
                clipregion = "province_owin",
                alternative = c("clustered"),
                nsim = 999)
```

-   Since p-value is less than 0.05, **there is sufficient evidence to reject the null hypothesis H0** that the distribution of road accidents is randomly distributed.

-   This is further supported by the R value of 0.19092. As this R value is less than 1, it indicates that **the pattern exhibits clustering and that the road accidents tend to occur close to one another and not in a dispersed/regular manner.**

### 8.1.2 Nearest Neighbour Analysis for each province

::: panel-tabset
## Bangkok

```{r}
clarkevans.test(roadacc_bkk_ppp.km,
                correction="none",
                clipregion=NULL,
                alternative=c("two.sided"),
                nsim=999)
```

## Nakhon Pathom

```{r}
clarkevans.test(roadacc_np_ppp.km,
                correction="none",
                clipregion=NULL,
                alternative=c("two.sided"),
                nsim=999)
```

## Nonthaburi

```{r}
clarkevans.test(roadacc_n_ppp.km,
                correction="none",
                clipregion=NULL,
                alternative=c("two.sided"),
                nsim=999)
```

## Pathum Thani

```{r}
clarkevans.test(roadacc_pt_ppp.km,
                correction="none",
                clipregion=NULL,
                alternative=c("two.sided"),
                nsim=999)
```

## Samut Prakan

```{r}
clarkevans.test(roadacc_sp_ppp.km,
                correction="none",
                clipregion=NULL,
                alternative=c("two.sided"),
                nsim=999)
```

## Samut Sakhon

```{r}
clarkevans.test(roadacc_ss_ppp.km,
                correction="none",
                clipregion=NULL,
                alternative=c("two.sided"),
                nsim=999)
```
:::

Based on the results above, for which all R values are less than 1 and all p-values are less than 0.05, we **reject the null hypothesis** at 95% confidence interval. **There is sufficient evidence to indicate that the distribution of road accidents in all provinces is not randomly distributed and instead exhibit clustering.**

## 9. Network Constrained SPPA

Network constrained SPPA (NetSPPA) is a collection of SAPPA methods specially developed for analysing spatial point events that occur on or alongside a network. In this case, it can be used for the analysis of road accidents that occur on or alongside the road lines network in the BMR.

Before we go into the analysis, we visualise the geospatial data (to save bandwidth, we directly use plot mode):

```{r}
tmap_mode('plot')
tm_shape(roadacc)+
  tm_dots(col = "red")+
  tm_shape(roadsbkk)+
  tm_lines()
```

### 9.1 Network KDE (NKDE) Analysis

NKDE is used to visualise and explore the intensity of point processes i.e. road accidents along the network i.e. road lines.

### 9.1.1 Determining appropriate bandwidth

Before we compute NKDE, we need to select an appropriate bandwidth. In this case we will use the K nearest neighbour adaptive bandwidth ([reference](https://jeremygelb.github.io/spNetwork/articles/web_vignettes/AdaptiveBW.html)). Under this method, the K nearest neighbour distance could be used as a locally adapted bandwidth for intensity estimation.

We will first use the nearest neighbour distance to understand the distance between road accident points along the road lines in BMR - we do this by running *nndist()* function on our ppp object:

```{r}
nnd_dist <- nndist(roadacc_owin_ppp.km)
summary(nnd_dist)
```

The median and max distance between road lines in BMR is 0.01303 km and 7.73467 km respectively.

We first aggregate events that are very close i.e. round up of median distance \~15 metres away:

```{r}
roadacc$weight <- 1
roadacc_agg <- aggregate_points(roadacc,15, weight = "weight")
```

We then calculate for each event its distance to its 20th neighbour:

```{r}
knn_dists <- network_knn(origins = roadacc_agg,
                         lines = roadsbkk,
                         k = 30,
                         maxdistance = 5000,
                         line_weight = "length",
                         digits = 2,
                         tol = 0.1)
```

```{r}
bws <- knn_dists$distances[,20]

ggplot()+
  geom_histogram(aes(x=bws),
                 fill = "white",
                 color = "black",
                 bins = 50)+
  labs(x = "distance to 20th neighbour (metres)")
```

Based on the histogram above, we note that there are some events for which the 20th neighbour is very far. We decide to trim the bandwidth at 10000 metres.

```{r}
trimmed_bw <- ifelse(bws > 10000,10000, bws)
```

### 9.1.2 Preparing the lixels objects

Before computing NKDE, the *roadsbkk* object needs to be cut into lixels with a specified minimal distance. We do this using [lixelize_lines()](https://jeremygelb.github.io/spNetwork/reference/lixelize_lines.html) of **spNetwork.**

To determine the appropriate lixel size to use, we need to consider several factors such as the scale of our study, density of accidents. road network characteristics. Some reasons are provided below:

-   [scale of study]{.underline}: shorter lixels may allow capturing of finer details for study of road accidents at a local scale however longer lixels may be more suitable to study patterns over larger distances.

-   [density of accidents]{.underline}: high road accident density areas may benefit from shorter lixels that would enable the capture of precise clustering on small road segments. however, long lixels can help to smooth out analysis for less dense areas and avoid overrepresenting sparsely populated segments

-   [road network characteristics]{.underline}: more complex road networks may benefit from shorter lixels to indicate the finer details of the road lines while larger road networks may work better with longer lixels.

Based on the analysis of K-nearest neighbors with adaptive bandwidth under [9.1.1 Determining appropriate bandwidth], we observe from the histogram that most road accidents occur within 1000m to 2000m of each other. We hence set the lixel lengths within this distance to help capture the density of accidents more effectively:

```{r}
lixels <- lixelize_lines(roadsbkk,
                         2000,
                         mindist = 1000)
samples <- lines_center(lixels)
```

```{r}
#| eval: false
densities <- nkde(lines = roadsbkk,
                  events = roadacc_agg,
                  w = roadacc_agg$weight,
                  samples = samples,
                  kernel_name = "quartic",
                  bw = trimmed_bw,
                  div = "bw",
                  adaptive = FALSE,
                  method = "simple",
                  digits = 1,
                  tol = 1,
                  grid_shape = c(5,5),
                  verbose = FALSE,
                  diggle_correction = FALSE,
                  study_area = NULL,
                  max_depth = 5,
                  agg = NULL,
                  sparse = TRUE)
```

To minimise re-running the code above, we save densities generated as a new rds file:

```{r}
#| code-fold: true
#| eval: false
write_rds(densities,"data/rds/densities.rds")
```

```{r}
#| code-fold: true
densities <- read_rds("data/rds/densities.rds")
```

### 9.1.3 Visualising NKDE

Before visualising NKDE values, we insert the computed density values into *samples* and *lixels* objects as density field. We also multiply the densities by 1000 to rescale the density values from metres (as the EPSG 32647 projection system is in metres which make the computed density values very small and hard to comprehend) to number of events per kilometer. We then map the result:

```{r}
# rescaling to help the mapping
samples$density <- densities*1000
lixels$density <- densities*1000
```

```{r}
#| eval: false
colorRamp <- brewer.pal(n = 5, name = "Spectral")
colorRamp <- rev(colorRamp)

samples2 <- samples[order(samples$density),]
title <- paste0("Road accident density by kilometres in BMR,",
                "\nusing an adaptive bandwidth (20th nearest neighbour)")

tmap_mode('plot')
tm_shape(roadsbkk) + 
  tm_lines("black") + 
  tm_shape(samples2) + 
  tm_dots("density", style = "kmeans", palette = colorRamp, n = 5, size = 0.1) + 
  tm_layout(legend.outside = TRUE, 
            main.title = title, main.title.size = 1)
```

![](images/clipboard-2585895702.png)

Plotting it in the lixel density format:

```{r}
colorRamp <- brewer.pal(n = 5, name = "RdYlGn")
colorRamp <- rev(colorRamp)

lix_density_break <- quantile(lixels$density, probs = seq(0, 1, length.out = 5))
title <- paste0("Road accident density by kilometres in BMR,",
                "\nusing an adaptive bandwidth (20th nearest neighbour)")

tmap_mode('plot')
tm_shape(lixels) +
  tm_lines(col = "density", palette = colorRamp, breaks = lix_density_break) +
  tm_shape(roadacc_agg) +
  tm_dots(col = "black", size = 0.01)+
  tm_layout(legend.outside = TRUE, 
            main.title = title, main.title.size = 1)
```

Based on the plot above, we observe the following:

-   Dense occurrence of road accidents within central Bangkok along intricate road networks where there are more complicated road lines

-   Denser occurrence of road accidents at intersections of road segments

## 10. Temporal SPPA

Events recorded on a network often have a temporal dimension. This is also applicable for road accidents in BMR which have incident datetime data. This will allow us to understand the distribution of road accidents across time and identify if there are certain time periods where road accidents might occur more often.

We will explore the density of road accidents in time, specifically by month, by day of week and by time of day. EDA exploring these time elements in the data can be found in [Part 1A](https://isss626-ksm.netlify.app/take-home_ex/take-home_ex01/take-home_ex01a#distribution-of-road-accidents-by-time).

### 10.1 Temporal Analysis of Road Accidents by Month

```{r}
roadacc$inc_month <- as.numeric(roadacc$inc_month)
roadacc$inc_dayofweek <- as.numeric(roadacc$inc_dayofweek)
roadacc$inc_time <- as.numeric(roadacc$inc_time)
```

We utilise the [tkde()](https://search.r-project.org/CRAN/refmans/spNetwork/html/tkde.html) function to calculate the temporal kernel density estimate.

We initialize the weights by creating a vector *w* where each element is 1, with a length equal to the number of rows in the *roadacc* data. This means that each road accident will be equally weight in the KDE calculation.

We also generate a sample range starting from the minimum to maximum month in *inc_month* column of the *roadacc dataset*, with increments of 0.5. As a recap, *inc_month* represents the month of the occurrence of the incident.

```{r}
w <- rep(1,nrow(roadacc))
samples <- seq(min(roadacc$inc_month),max(roadacc$inc_month),0.5)
```

The kernel density estimation is calculated for several bandwidths (bw 1 to bw 6 as seen in the codes below). Each bandwidth gives a different smoothing effect on the density estimate. bw 1 gives a more sensitive estimate, capturing fine details in the distribution of road accidents while larger bandwidth bw 6 will create a smoother density estimate by averaging over a wider range of data points.

```{r}
month_kernel_val <- data.frame(
  bw_1 = tkde(roadacc$inc_month, w=w, samples = samples, bw = 1, kernel_name = "quartic"),
  bw_2 = tkde(roadacc$inc_month, w=w, samples = samples, bw = 2, kernel_name = "quartic"),
  bw_3 = tkde(roadacc$inc_month, w=w, samples = samples, bw = 3, kernel_name = "quartic"),
  bw_4 = tkde(roadacc$inc_month, w=w, samples = samples, bw = 4, kernel_name = "quartic"),
  bw_5 = tkde(roadacc$inc_month, w=w, samples = samples, bw = 5, kernel_name = "quartic"),
  bw_6 = tkde(roadacc$inc_month, w=w, samples = samples, bw = 6, kernel_name = "quartic"),
  month = samples
)
```

```{r}
df_month <- reshape2::melt(month_kernel_val, id.vars = "month")

df_month$variable <- as.factor(df_month$variable)

ggplot(data = df_month)+
  geom_line(aes(x=month,y=value))+
  scale_x_continuous(breaks =1:12, labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  facet_wrap(vars(variable),ncol=2, scales="free")+
  labs(title = "Temporal KDE for Occurrence of Road Accidents by Month", x = "Month", y="Density")+
  theme(axis.text = element_text(size = 5))
```

Based on the plots above, we observe that:

-   the density curve for bw 1 is more jagged, reflecting more clearly the variations between the months - there are more significant drops in densities of road accidents in Feb, May and Nov while there are significant increases in densities of road accidents slightly before Apr, Oct and Dec.

-   the density curve starts to smooth out from bw 2. bw 3 and bw 4 seem to best capture the bimodal shape of the temporal dimension of road accidents before the bimodal shape starts to be less obvious in bw 5 and is entirely gone in bw 6 (this is hence why we stop at bw 6 and do not explore further bandwidths).

-   for bw 3 and 4, it is clear that occurrence of road accidents is most dense at the start (\~Mar to Apr) and end of the year (towards the Oct period), while the occurrence of road accidents is less dense in the middle part of the year. This could be explained by the holiday seasons near the start and end of year that could have led to higher traffic on the roads. Further, the peak near Apr could be explained by the Songkran (Thai New Year) Festival that occurs annually in Apr, which could have led to more traffic and pedestrians on the road, increasing the chances of accidents.

### 10.2 Temporal Analysis of Road Accidents by Day of Week

We conduct a similar analysis to study the distribution of road accidents by day of week. It is important to recall that we assigned the week to start from Monday during the data wrangling steps in [Part 1A](https://isss626-ksm.netlify.app/take-home_ex/take-home_ex01/take-home_ex01a#creating-new-variables-representing-month-day-of-week-time-of-day-as-well-as-gap-between-incident-and-reporting-time).

```{r}
w <- rep(1,nrow(roadacc))
samples <- seq(min(roadacc$inc_dayofweek),max(roadacc$inc_dayofweek),0.5)

day_kernel_val <- data.frame(
  bw_1 = tkde(roadacc$inc_dayofweek, w=w, samples = samples, bw = 1, kernel_name = "quartic"),
  bw_2 = tkde(roadacc$inc_dayofweek, w=w, samples = samples, bw = 2, kernel_name = "quartic"),
  bw_3 = tkde(roadacc$inc_dayofweek, w=w, samples = samples, bw = 3, kernel_name = "quartic"),
  bw_4 = tkde(roadacc$inc_dayofweek, w=w, samples = samples, bw = 4, kernel_name = "quartic"),
  day = samples
)
```

```{r}
df_day <- reshape2::melt(day_kernel_val, id.vars = "day")
df_day$variable <- as.factor(df_day$variable)

ggplot(data = df_day)+
  geom_line(aes(x=day,y=value))+
  scale_x_continuous(breaks =1:7, labels = c("Mon","Tues","Wed","Thu","Fri","Sat","Sun")) +
  facet_wrap(vars(variable),ncol=2, scales="free")+
  labs(title = "Temporal KDE for Occurrence of Road Accidents by Day of the Week", x = "Day", y="Density")+
  theme(axis.text = element_text(size = 5))
```

Based on the plots above, we observe that:

-   the density curve for bw 1 is more jagged, reflecting more clearly the variations between the days - there are more significant increases in densities of road accidents from Fri to Sat. This could be explained by Fri and Sat being the start of the weekend and more traffic and pedestrians being out on the road for social activities.

-   the density curve starts to smooth out in bw 2 and seem to best capture the bimodal shape of the temporal dimension of road accidents - the density of road accidents increase between Fri to Sat and then drop on Sun and Mon before increasing on Tues again. As stated in the above point, the increase between Fri and Sat can be explained by these days being the start of the weekend, the drop in Sun and Mon could be due to less traffic as people start to get ready for the work/school week ahead and potentially even Mon blues when less people might travel to work. The increase in road accidents from Tues could be due to the steady stream of office workers/school children heading to office/school.

-   The bimodal shape becomes less obvious/almost entirely gone in bw3 and 4 (this is hence why we stop at bw 4 and do not explore further bandwidths).

### 10.3 Temporal Analysis of Road Accidents by Time of Day

We conduct a similar analysis to study the distribution of road accidents by time of day.

```{r}
w <- rep(1,nrow(roadacc))
samples <- seq(min(roadacc$inc_time),max(roadacc$inc_time),0.5)

time_kernel_val <- data.frame(
  bw_1 = tkde(roadacc$inc_time, w=w, samples = samples, bw = 1, kernel_name = "quartic"),
  bw_2 = tkde(roadacc$inc_time, w=w, samples = samples, bw = 2, kernel_name = "quartic"),
  bw_3 = tkde(roadacc$inc_time, w=w, samples = samples, bw = 3, kernel_name = "quartic"),
  bw_4 = tkde(roadacc$inc_time, w=w, samples = samples, bw = 4, kernel_name = "quartic"),
  bw_5 = tkde(roadacc$inc_time, w=w, samples = samples, bw = 5, kernel_name = "quartic"),
  bw_6 = tkde(roadacc$inc_time, w=w, samples = samples, bw = 6, kernel_name = "quartic"),
  time = samples
)
```

```{r}
df_time <- reshape2::melt(time_kernel_val, id.vars = "time")
df_time$variable <- as.factor(df_time$variable)

ggplot(data = df_time)+
  geom_line(aes(x=time,y=value))+
  scale_x_continuous(breaks =1:24) +
  facet_wrap(vars(variable),ncol=2, scales="free")+
  labs(title = "Temporal KDE for Occurrence of Road Accidents by Time of Day", x = "Time", y="Density")+
  theme(axis.text = element_text(size = 5))
```

Based on the plots above, we observe that:

-   the density curve for bw 1 is more jagged, reflecting more clearly the variations between the hours of the day - there are more significant increases in densities of road accidents from 7am. This could be explained by 7am being the start of the day and more traffic and pedestrians being out on the road for their daily activities.

-   the density curve starts to smooth out from bw 2 showing the period of 7am to 11am as the peak of the density of road accidents, how it dips from 12pm to 1pm (which could be explained by it being lunch hour and regular workers might be having their lunch rather than being out on the road) and the slight increase between 6pm to 8pm which is the knock-off time for office workers, hence leading to more traffic and pedestrians on the road. the density of road accidents dip significantly from 11pm which could be explained by it being the end of the day for most people hence leading to less traffic on the road and lower chances of road accidents occurring.

-   the density curve starts to smooth out significantly from bw 3 onwards before forming an entirely smooth hump in bw 6 (this is hence why we stop at bw 6 and do not explore further bandwidths).

## 11. Spatio-Temporal SPPA

We now combine the separate spatial and temporal analysis carried out in sections above under one combined spatio-temporal analysis.

-   While spatial analysis helps us to understand the pattern of events i.e. road accidents across geographical locations, it treats time as static and might miss how phenomena evolves over time.

-   While temporal analysis studies changes over time, it ignores spatial relationships and might overlook how events at different locations might be interconnected.

-   Spatio-temporal analysis provides an understanding of how events, in this case road accidents, are change across both space and time.

Under this section, the specific research questions we would like to answer are:

-   are the locations of road accidents in BMR spatially and spatio-temporally independent?

-   if the answer is no, where and when do the observed road accidents tend to cluster?

### 11.1 By Month

### 11.1.1 Visualising geographic distribution of road accidents by month

As a recap, we visualise the distribution of road accidents by month:

```{r}
tm_shape(provincedata32647)+
  tm_polygons()+
  tm_shape(roadacc)+
  tm_dots(size=0.05,col = "blue",alpha =0.5)+
  tm_facets(by="inc_month",
            free.coords = FALSE,
            drop.units = TRUE)
```

As can be seen, there seem to be more road accidents in Apr, Oct and Dec.

### 11.1.2 Computing Spatio-Temporal KDE (STKDE) by month

In this section, we will compute STKDE using [`spattemp.density()`](https://tilmandavies.github.io/sparr/reference/spattemp.density.html) of **sparr** package.

### 11.1.2.1 Extracting road accidents by month

The code chunk below removes the unwanted fields from *roadacc* dataframe as *as.ppp()* only requires the month and geometry field from the input *roadacc* sf dataframe.

```{r}
roadacc_month <- roadacc %>%
  select(inc_month)
```

### 11.1.2.2 Creating ppp object

The code chunk below is used to derive a ppp object frm the *roadacc_month* sf dataframe:

```{r}
roadacc_month_ppp <- as.ppp(roadacc_month)
roadacc_month_ppp
```

The code chunk below is used to check that the output is in the correct object class:

```{r}
summary(roadacc_month_ppp)
```

We note that there are duplicated point events from the code below:

```{r}
any(duplicated(roadacc_month_ppp))
```

We use the *multiplicity()* function to count the number of co-incident points:

```{r}
multiplicity(roadacc_month_ppp)
```

```{r}
sum(multiplicity(roadacc_month_ppp) > 1)
```

The output shows that there are 639 duplicated point events.

We will resolve this using jittering, which will add a small pertubation to the duplicate points so that they do not occupy the exact same space:

```{r}
roadacc_month_ppp_jit <- rjitter(roadacc_month_ppp,
                                 retry = TRUE,
                                 nsim = 99,
                                 drop = TRUE)
```

We then check for duplicated points to determine if the jittering was carried out successfully:

```{r}
any(duplicated(roadacc_month_ppp_jit))
```

The output indicates that there are no duplicated points.

### 11.1.2.3 Including owin object

The code chunk below is used to combine *roadacc_month_ppp* and *provinceowin* into one object:

```{r}
roadacc_month_owin_ppp <- roadacc_month_ppp[provinceowin]
```

```{r}
summary(roadacc_month_owin_ppp)
```

We plot the *roadacc_month_owin_ppp* object to examine the correctness of the output object:

```{r}
plot(roadacc_month_owin_ppp)
```

### 11.1.2.4 Computing STKDE

We first use `BOOT.spattemp()` to determine the spatial bandwidth and the scalar temporal bandwidth for use in subsequent calculation.

```{r}
#| eval: false
set.seed(1234) 
BOOT.spattemp(roadacc_month_owin_ppp)
```

![](images/clipboard-3519234755.png){width="192" height="47"}

Next, we use `spattemp.density()` of sparr package to compute the STKDE, with h and lambda values derived in previous step.

```{r}
st_kde <- spattemp.density(roadacc_month_owin_ppp,
                           h=2300,
                           lambda=2)
summary(st_kde)
```

### 11.1.2.5 Plotting the STKDE object

```{r}
#| code-fold: true
firsthalfyear <- c(1,2,3,4,5,6)

par(mfrow=c(2,3))
for(i in firsthalfyear){ 
  plot(st_kde, i, 
       override.par=FALSE, 
       fix.range=TRUE, 
       main=paste("KDE at month",i))
}
```

```{r}
#| code-fold: true
secondhalfyear <- c(7,8,9,10,11,12)

par(mfrow=c(2,3))
for(i in secondhalfyear){ 
  plot(st_kde, i, 
       override.par=FALSE, 
       fix.range=TRUE, 
       main=paste("KDE at month",i))
}
```

**Observations from the Temporal KDE and Spatio-Temporal KDE plots are summarised in the table below:**

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Observation from Temporal KDE                                                                                                                                                                                                  | Observation from Spatio-Temporal KDE                                                                                              | Conclusion from both observations                                                                                                                                                                   |
+================================================================================================================================================================================================================================+===================================================================================================================================+=====================================================================================================================================================================================================+
| -   Occurrence of road accidents is most dense at the start (especially towards Mar to Apr) and end of the year (towards the Oct period), while the occurrence of road accidents is less dense in the middle part of the year. | -   Dense occurrence of road accidents in the later half of the year i.e Oct to Dec, as compared to the earlier half of the year. | While there are differences in temporal KDE and Spatio-Temporal KDE plots, together they indicate the following:                                                                                    |
|                                                                                                                                                                                                                                |                                                                                                                                   |                                                                                                                                                                                                     |
|                                                                                                                                                                                                                                |                                                                                                                                   | -   **Road accidents tend to occur more intensely at the end of the year, with lower occurrences in the middle segment of the year.**                                                               |
|                                                                                                                                                                                                                                |                                                                                                                                   |                                                                                                                                                                                                     |
|                                                                                                                                                                                                                                |                                                                                                                                   | -   **There could be a high overall accident count in Mar to Apr** but the spatial distribution during this period might be more **dispersed**, leading to less prominent hotspots in the KDE maps. |
|                                                                                                                                                                                                                                |                                                                                                                                   |                                                                                                                                                                                                     |
|                                                                                                                                                                                                                                |                                                                                                                                   | -   **Oct to Dec seem to have high overall accident counts that are concentrated leading to very prominent hotspots in the KDE map.**                                                               |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

### 11.2 By Day of Week

### 11.2.1 Visualising geographic distribution of road accidents by day of week

We run similar steps in section 11.1 above to study the distribution of road accidents by day of week.

```{r}
tm_shape(provincedata32647)+
  tm_polygons()+
  tm_shape(roadacc)+
  tm_dots(size=0.05,col = "blue",alpha =0.5)+
  tm_facets(by="inc_dayofweek",
            free.coords = FALSE,
            drop.units = TRUE)
```

Visually, there seem to be more road accidents on Fri and Sat.

### 11.2.2 Computing Spatio-Temporal KDE (STKDE) by day of week

### 11.2.2.1 Creating ppp object

```{r}
roadacc_day_ppp <- roadacc %>%
  select(inc_dayofweek) %>%
  as.ppp()
```

We note that there are duplicated point events from the code below:

```{r}
any(duplicated(roadacc_day_ppp))
```

We use the *multiplicity()* function to count the number of co-incident points:

```{r}
multiplicity(roadacc_day_ppp)
```

```{r}
sum(multiplicity(roadacc_day_ppp) > 1)
```

The output shows that there are 779 duplicated point events.

We will resolve this using jittering, which will add a small pertubation to the duplicate points so that they do not occupy the exact same space:

```{r}
roadacc_day_ppp_jit <- rjitter(roadacc_day_ppp,
                                 retry = TRUE,
                                 nsim = 99,
                                 drop = TRUE)
```

We then check for duplicated points to determine if the jittering was carried out successfully:

```{r}
any(duplicated(roadacc_day_ppp_jit))
```

The output indicates that there are no duplicated points.

### 11.2.2.2 Including owin object

Next, we combine the ppp object and the owin object:

```{r}
roadacc_day_owin_ppp <- roadacc_day_ppp[provinceowin]
```

```{r}
summary(roadacc_day_owin_ppp)
```

We plot the *roadacc_day_owin_ppp* object to examine the correctness of the output object:

```{r}
plot(roadacc_day_owin_ppp)
```

### 11.2.2.3 Computing STKDE

We first use `BOOT.spattemp()` to determine the spatial bandwidth and the scalar temporal bandwidth for use in subsequent calculation.

```{r}
#| eval: false
set.seed(1234)
BOOT.spattemp(roadacc_day_owin_ppp)
```

![](images/clipboard-4283319503.png){width="172" height="37"}

Next, we use `spattemp.density()` of sparr package to compute the STKDE, with h and lambda values derived in previous step.

```{r}
st_kde_day <- spattemp.density(roadacc_day_owin_ppp,
                               h = 2500 ,
                               lambda = 0.7) 
summary(st_kde_day)
```

### 11.2.3 Plotting the STKDE object

```{r}
fullweek <- c(1,2,3,4,5,6,7)
par(mfrow=c(2,3)) 
for(i in fullweek){
  plot(st_kde_day, i,
       override.par=FALSE,
       fix.range=TRUE,
       main=paste("KDE at day",i))
  }
```

**Observations from the Temporal KDE and Spatio-Temporal KDE plots are summarised in the table below:**

+---------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Observation from Temporal KDE                                 | Observation from Spatio-Temporal KDE                                                                                                                  | Conclusion from both observations                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+===============================================================+=======================================================================================================================================================+==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+
| -   Occurrence of road accidents is most dense on Fri and Sat | -   Dense occurrence of road accidents from Fri to Mon, however road accidents on Sun and Mon seem to be more spatially concentrated than Fri and Sat | While there are differences in temporal KDE and Spatio-Temporal KDE plots, together they indicate the following:                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                               |                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|                                                               |                                                                                                                                                       | -   **Road accidents occur in high accident counts at the start of the weekend**                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                               |                                                                                                                                                       | -   **The spatial distribution of road accidents on Sun and Mon are more concentrated as compared to Fri and Sat**, leading to **more prominent hotspots in the KDE map.**                                                                                                                                                                                                                                                                                                                                   |
|                                                               |                                                                                                                                                       |     -   **This could potentially be explained by Fri and Sat being the start of the weekend vs Sun and Mon which are closer to the start of the week and while people may venture out to different places to carry out their social activities on Fri and Sat, they may travel to a smaller subset of locations i.e. home on Sun to rest before the start of the week or to work/school on Mon for the start of the week, hence leading to more concentrated occurrences of road accidents on Sun and Mon.** |
+---------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

### 11.3 By Time of Day

We run similar steps as above to study the distribution of road accidents by time of day.

### 11.3.1 Computing Spatio-Temporal KDE (STKDE) by time of day

### 11.3.1.1 Creating ppp object

```{r}
roadacc_time_ppp <- roadacc %>%
  select(inc_time) %>%
  as.ppp()
```

We note that there are duplicated point events from the code below:

```{r}
any(duplicated(roadacc_time_ppp))
```

We use the *multiplicity()* function to count the number of co-incident points:

```{r}
multiplicity(roadacc_time_ppp)
```

```{r}
sum(multiplicity(roadacc_time_ppp) > 1)
```

The output shows that there are 395 duplicated point events.

We will resolve this using jittering, which will add a small pertubation to the duplicate points so that they do not occupy the exact same space:

```{r}
roadacc_time_ppp_jit <- rjitter(roadacc_time_ppp,
                               retry = TRUE,
                               nsim = 99,
                               drop = TRUE)
```

We then check for duplicated points to determine if the jittering was carried out successfully:

```{r}
any(duplicated(roadacc_time_ppp_jit))
```

The output indicates that there are no duplicated points.

### 11.3.1.2 Including owin object

Next, we combine the ppp object and the owin object:

```{r}
roadacc_time_owin_ppp <- roadacc_time_ppp[provinceowin]
```

```{r}
summary(roadacc_time_owin_ppp)
```

We plot the *roadacc_time_owin_ppp* object to examine the correctness of the output object:

```{r}
plot(roadacc_time_owin_ppp)
```

### 11.3.1.3 Computing STKDE

We first use `BOOT.spattemp()` to determine the spatial bandwidth and the scalar temporal bandwidth for use in subsequent calculation.

```{r}
#| eval: false
set.seed(1234) 
BOOT.spattemp(roadacc_time_owin_ppp)
```

![](images/clipboard-3695285983.png){width="190"}

Next, we use `spattemp.density()` of sparr package to compute the STKDE, with h and lambda values derived in previous step.

```{r}
st_kde_time <- spattemp.density(roadacc_time_owin_ppp,
                               h = 2400 ,
                               lambda = 2)
summary(st_kde_time)
```

### 11.3.2 Plotting the STKDE object

Based on the EDA carried out in [Part 1A](https://isss626-ksm.netlify.app/take-home_ex/take-home_ex01/take-home_ex01a#by-time-of-day), we note that the distribution of road accidents across time can be divided into four different time segments:

-   12am to 6am: Midnight to dawn

-   7am to 11am: Morning

-   12pm to 5pm: Midday

-   6pm to 11pm: Evening to night

### 11.3.2.1 STKDE from Midnight to dawn (12am to 6am)

```{r}
#| code-fold: true
midnighttodawn <- c(0,1,2,3,4,5,6)

par(mfrow=c(2,3))  

for(i in midnighttodawn){
  plot(st_kde_time, i,
       override.par=FALSE,
       fix.range=TRUE,
       main=paste("KDE at time",i))
  }
```

### 11.3.2.2 STKDE for Morning (7am to 11am)

```{r}
#| code-fold: true
morning <- c(7,8,9,10,11)

par(mfrow=c(2,3))  

for(i in morning){
  plot(st_kde_time, i,
       override.par=FALSE,
       fix.range=TRUE,
       main=paste("KDE at time",i))
  }
```

### 11.3.2.3 STKDE for Midday (12pm to 5pm)

```{r}
#| code-fold: true
midday <- c(12,13,14,15,16,17)

par(mfrow=c(2,3))  

for(i in midday){
  plot(st_kde_time, i,
       override.par=FALSE,
       fix.range=TRUE,
       main=paste("KDE at time",i))
  }
```

### 11.3.2.4 STKDE for Evening to Night (6pm to 11pm)

```{r}
#| code-fold: true
eveningtonight <- c(18,19,20,21,22,23)

par(mfrow=c(2,3))  

for(i in eveningtonight){
  plot(st_kde_time, i,
       override.par=FALSE,
       fix.range=TRUE,
       main=paste("KDE at time",i))
  }
```

As seen from the plots above, the occurrence of road accidents is more intense during the hours from 7am to 11pm as compared to midnight to dawn hours from 12am to 6am. The hotspots between 7am to 11pm are at similar locations, concentrated along the edges of Bangkok.

## 12. Conclusion

Combining the insights from all analyses carried out in this exercise:

+--------+------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| S/N    | Key Topic              | General insights from EDA                                                                                                                                                                     | Spatial                                                                                         | Spatio-Temporal Insights                                                                                                                                      | Recommendations on next steps                                                                                                                                                                                                                                                                                                                                                                                            |
+:=======+:=======================+:==============================================================================================================================================================================================+:================================================================================================+:==============================================================================================================================================================+:=========================================================================================================================================================================================================================================================================================================================================================================================================================+
| **1**  | **Location**           | -   Observe highest concentration of road accidents in Bangkok, followed by Samut Prakan, Pathum Thani, Samut Sakhon, Nakhon Pathom and Nonthaburi                                            | -   Road accidents across BMR are not randomly distributed and exhibit clustering               | \-                                                                                                                                                            | -   Prioritise road accident prevention efforts on Bangkok and Samut Prakan, followed by Pathum Thani, Samut Sakhon, Nakhon Pathom and finally Nonthaburi                                                                                                                                                                                                                                                                |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        |     -   Increasing trend in Bangkok and Samut Prakan over the years                                                                                                                           | -   Road accidents occur more intensely along the road lines in Bangkok and Samut Prakan        |                                                                                                                                                               | -   Within the provinces, to conduct in-depth study on conditions of straight roads and roads with no slopes, especially at points where such roads meet at intersections. This can be followed by studies on roads with wide curve and grade-separated intersection/ramps.                                                                                                                                              |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        |     -   Space for improvement for Pathum Thani, Samut Sakhon and Nonthaburi as they experience fluctuating number of road accidents over the years                                            |     -   Dense occurrence of road accidents within central Bangkok along intricate road networks |                                                                                                                                                               | -   Preventive measures can be:                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        |     -   Nakhon Pathom can be last priority of focus as the road accidents have decreased over the years                                                                                       | -   Overall, observe denser occurrence of road accidents at intersections of road segments      |                                                                                                                                                               |     -   Public education campaigns that highlight the risks of road accidents even on seemingly safe straight roads, to increase driver's and pedestrians' awareness of risks and not to be complacent.                                                                                                                                                                                                                  |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        | -   Road accidents mostly occur on straight road conditions and on roads with no slopes. Wide curve and grade-separated intersection/ramps are also top road descriptions for road accidents. |                                                                                                 |                                                                                                                                                               |     -   Clearer signs can be placed along straight roads to remind drivers and pedestrians of safe road practices.                                                                                                                                                                                                                                                                                                       |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |     -   Place more cameras along these roads to capture errant/risky behaviour and to send warning/enforcement letters to prevent the same driver/pedestrian from making similar/more severe mistakes in future                                                                                                                                                                                                          |
+--------+------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **2**  | **Time**               | -   Road accidents **tend to occur more often near the start and end of the year**                                                                                                            | \-                                                                                              | -   Road accidents **tend to occur more intensely at the end of the year**, with lower occurrences in the middle segment of the year.                         | -   To focus on preventive efforts in the later months of the year i.e. ramp up public education campaigns, to patrol the roads more often or to set up more traffic control points as compared to the early months of the year                                                                                                                                                                                          |
|        |                        |                                                                                                                                                                                               |                                                                                                 |     -   **There could be a high overall accident count at the start of the year** but the spatial distribution during this period might be more **dispersed** |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        |     -   Increasing trend of road accidents in the later months i.e. Oct to Dec, over the years                                                                                                |                                                                                                 |                                                                                                                                                               | -   To step up road control measures from Fri to Mon                                                                                                                                                                                                                                                                                                                                                                     |
|        |                        |                                                                                                                                                                                               |                                                                                                 |     -   **Road accidents near the end of the year seem to be more concentrated**                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        | -   Road accidents seem to **occur more on Fri and Sat**                                                                                                                                      |                                                                                                 | -   **Road accidents occur in high accident counts at the start of the weekend**                                                                              |     -   For Fri and Sat, the spatial distribution of road accidents are more dispersed hence might require more manpower to form a larger patrol group or more traffic check points to monitor traffic and prevent accidents                                                                                                                                                                                             |
|        |                        |                                                                                                                                                                                               |                                                                                                 |     -   **The spatial distribution of road accidents on Sun and Mon are more concentrated as compared to Fri and Sat**                                        |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        | -   Road accidents seem to **occur more often between 7am to 11pm, with the top two timings at 9am and 7pm**                                                                                  |                                                                                                 | -   Occurrence of road accidents is **more intense during the hours from 7am to 11pm**                                                                        |     -   For Sun and Mon, the spatial distribution of road accidents is more concentrated. A study can be carried out to shortlist the hotspots and patrol or traffice control efforts can be more focused on these areas on these two days                                                                                                                                                                               |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               | -   As the peak hours are at 9am and 7pm, Thai government can considering introducing policies to encourage the population to head to work or school at earlier or later timings to stagger traffic and reduce the risks of accidents. For instance, offering discount toll rates or public transport fees at earlier or later offpeak timings to entice population to utilise the transport modes at different timings. |
+--------+------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **3**  | **Weather conditions** | -   Road accidents most frequently occur during clear weather conditions followed by rainy and dark conditions                                                                                | \-                                                                                              | \-                                                                                                                                                            | -   To focus on needle-moving strategies that can prevent road accidents during clear weather conditions i.e. to install more warning signs and speed cameras along the locations stated in S/N 1 for deterrence.                                                                                                                                                                                                        |
+--------+------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **4**  | **Human factors**      | -   Road accidents mostly involve private/passenger car, followed by 4-wheel pickup truck and motorcycle as top 3 vehicles                                                                    | \-                                                                                              | \-                                                                                                                                                            | -   To focus public education efforts on drivers with private/passenger car, 4-wheel pickup truck and motorcycle licenses i.e. mailers to these group of drivers. As a pre-emptive measure, to place greater emphasis on safety practices and road guidelines when prospective drivers apply for the licenses for these vehicles.                                                                                        |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        | -   Top presumed cause is speeding                                                                                                                                                            |                                                                                                 |                                                                                                                                                               | -   To set up more speed cameras along locations in S/N 1 to identify errant drivers and as a form of deterrence.                                                                                                                                                                                                                                                                                                        |
|        |                        |                                                                                                                                                                                               |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
|        |                        | -   Top accident types are rear-end collision and rollover/fallen on straight road                                                                                                            |                                                                                                 |                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                          |
+--------+------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

## 13. References

-   <https://wiki.openstreetmap.org/wiki/WikiProject_Thailand#Highway_classification>

-   <https://cran.r-project.org/web/packages/spNetwork/vignettes/NKDE.html>

-   <https://jeremygelb.github.io/spNetwork/articles/web_vignettes/AdaptiveBW.html>

-   <https://jeremygelb.github.io/spNetwork/articles/NKDE.html>

-   <https://jeremygelb.github.io/spNetwork/articles/TNKDE.html>
